{% extends "base.html" %}

{% block title %}IT Compliance Auditor - Will Robinson{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">IT Compliance Auditor</h1>
    <p class="text-center">Scans AWS for compliance violations.</p>

    <!-- ‚úÖ Store is_admin as a hidden div for JavaScript -->
    <div id="isAdminData" data-is-admin="{{ is_admin | tojson | safe }}" style="display: none;"></div>

    {% if is_admin %}
    <!-- Compliance Scan Results -->
    <div class="card p-4 mt-4">
        <h3 class="text-center">AWS Compliance Findings</h3>
        <p class="text-center">Detected violations and security risks.</p>

        <div id="complianceResults">
            <p class="text-center">Loading compliance findings...</p>
        </div>
    </div>

    <div class="text-center mt-4">
        <button id="refreshCompliance" class="btn btn-primary">üîÑ Refresh Compliance Report</button>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('logout', next=request.path) }}" class="btn btn-danger">üö™ Logout</a>
    </div>
    {% else %}
    <div class="text-center mt-4">
        <!-- ‚úÖ Ensure proper redirect after login -->
        <a href="{{ url_for('login', next=request.path) }}" class="btn btn-warning">
            üîë Login to View Compliance Reports
        </a>
    </div>
    {% endif %}

    <!-- Compliance Auditor Dashboard Image (Always Visible) -->
    <div class="text-center mt-4">
        <p class="text-muted">üîç Click to enlarge the IT Compliance Auditor preview</p>
        <a href="#" data-bs-toggle="modal" data-bs-target="#complianceImageModal">
            <img src="{{ url_for('static', filename='images/complianceAuditor.png') }}" 
                 alt="IT Compliance Auditor" class="img-thumbnail" style="max-width: 200px;">
        </a>
    </div>

    <!-- Bootstrap Modal for Enlarged Image -->
    <div class="modal fade" id="complianceImageModal" tabindex="-1" aria-labelledby="complianceImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="complianceImageModalLabel">IT Compliance Auditor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="{{ url_for('static', filename='images/complianceAuditor.png') }}" 
                         alt="IT Compliance Auditor" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Go Back Button -->
    <div class="text-center mt-4">
        <a href="{{ url_for('project_detail', project_id='it-compliance-auditor') }}" class="btn btn-secondary">
            ‚¨ÖÔ∏è Go Back to Project Details
        </a>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Compliance Auditor script loaded!");

    const refreshButton = document.getElementById("refreshCompliance");
    const complianceContainer = document.getElementById("complianceResults");

    // ‚úÖ Extract isAdmin value from the hidden div
    const isAdminElement = document.getElementById("isAdminData");
    const isAdmin = isAdminElement ? JSON.parse(isAdminElement.getAttribute("data-is-admin")) : false;

    console.log("DEBUG: isAdmin =", isAdmin);  // ‚úÖ Debugging

    if (!isAdmin) {
        console.warn("üîí User NOT logged in. Compliance data is restricted.");
        if (complianceContainer) {
            complianceContainer.innerHTML = `<p class='text-center text-warning'>üîí Please log in to view compliance reports.</p>`;
        }
        return;
    }

    console.log("üü¢ User is logged in. Fetching compliance data...");
    fetchComplianceData();
    refreshButton?.addEventListener("click", fetchComplianceData);

    function fetchComplianceData() {
        console.log("üì° Fetching compliance findings...");

        fetch("/it-compliance/api/compliance")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!complianceContainer) {
                    console.error("‚ùå ERROR: complianceContainer is not found in the DOM.");
                    return;
                }

                complianceContainer.innerHTML = "";

                if (data.length === 0 || data.error) {
                    complianceContainer.innerHTML = "<p class='text-center text-success'>‚úÖ No active compliance violations detected!</p>";
                    return;
                }

                let tableHtml = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Severity</th>
                                <th>Resource</th>
                                <th>Description</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(finding => {
                    let severityClass = finding.severity === "CRITICAL" ? "text-danger fw-bold" : 
                                        finding.severity === "HIGH" ? "text-warning fw-bold" : 
                                        "text-success";

                    tableHtml += `
                        <tr>
                            <td>${finding.title}</td>
                            <td class="${severityClass}">${finding.severity}</td>
                            <td>${finding.resource}</td>
                            <td>${finding.description}</td>
                            <td>${finding.recommendation}</td>
                        </tr>
                    `;
                });

                tableHtml += "</tbody></table>";
                complianceContainer.innerHTML = tableHtml;
            })
            .catch(error => {
                console.error("‚ùå Error fetching compliance findings:", error);
                if (complianceContainer) {
                    complianceContainer.innerHTML = "<p class='text-danger'>‚ùå Error loading compliance data.</p>";
                }
            });
    }
});
</script>    

{% endblock %}
